"use strict";var app=angular.module("app",["ngAria","ngMessages","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngAnimate","ngTouch","ui.bootstrap","notification","ngWebsocket","ngFileUpload","Config"]).config(["$routeProvider","$httpProvider","USER_ROLES",function(a,b){a.when("/403",{templateUrl:"views/403.html",data:{authorizedRoles:[b.NOT_LOGGED]}}),a.when("/arquivos",{templateUrl:"views/arquivos.html",controller:"ArquivosController",data:{authorizedRoles:[b.NOT_LOGGED]}}),a.when("/login",{templateUrl:"views/login.html",controller:"AuthController",data:{authorizedRoles:[b.NOT_LOGGED]}}),a.when("/dashboard",{templateUrl:"views/dashboard/dashboard.html",controller:"DashboardController",data:{authorizedRoles:[b.NOT_LOGGED]}}),a.otherwise({redirectTo:"/dashboard",data:{authorizedRoles:[b.NOT_LOGGED]}})}]);app.config(["$httpProvider","$websocketProvider","$sceDelegateProvider",function(a,b,c){c.resourceUrlWhitelist(["self"]),a.interceptors.push(["$q","$rootScope","AppService","ENV",function(a,b,c,d){return{request:function(e){b.$broadcast("loading-started");var f=c.getToken();return-1!==e.url.indexOf("api")&&-1===e.url.indexOf(d.apiEndpoint)&&(e.url=d.apiEndpoint+e.url),f&&(e.headers.Authorization="Token "+f),e||a.when(e)},response:function(c){return b.$broadcast("loading-complete"),c||a.when(c)},responseError:function(c){return b.$broadcast("loading-complete"),a.reject(c)},requestError:function(c){return b.$broadcast("loading-complete"),a.reject(c)}}}]),a.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]),app.run(["$rootScope","$location","$window","AUTH_EVENTS","APP_EVENTS","USER_ROLES","AuthService","AppService","AlertService","WS","$notification","$http",function(a,b,c,d,e,f,g,h,i,j,k,l){a.$on("$routeChangeStart",function(b,c){if("/"!==c.redirectTo){var e=c.data.authorizedRoles;void 0!==e[0]&&-1===e.indexOf(f.NOT_LOGGED)&&(g.isAuthorized(e)||(b.preventDefault(),g.isAuthenticated()?a.$broadcast(d.notAuthorized):a.$broadcast(d.notAuthenticated)))}}),a.$on(d.quantidade,function(b,c){a.$apply(function(){a.conectados=c.emit.data})}),a.$on(d.notAuthorized,function(){console.log("notAuthorized"),b.path("/403")}),a.$on(d.notAuthenticated,function(){console.log("notAuthenticated"),a.currentUser=null,h.removeToken(),b.path("/login")}),a.$on(d.sessionTimeout,function(){console.log("sessionTimeout")}),a.$on(d.loginFailed,function(){console.log("loginFailed"),h.removeToken(),b.path("/login")}),a.$on(d.logoutSuccess,function(){console.log("logoutSuccess"),j.command("logout",a.currentUser.nome),a.currentUser=null,h.removeToken(),b.path("/dashboard")}),a.$on(d.loginSuccess,function(){b.path("/dashboard"),j.command("login",a.currentUser.nome)}),a.$on(e.offline,function(){i.addWithTimeout("danger","Servidor esta temporariamente indisponível, tente mais tarde")}),c.addEventListener("load",function(a){c.applicationCache.addEventListener("updateready",function(a){console.log(c.applicationCache.status),c.applicationCache.status===c.applicationCache.UPDATEREADY&&(c.location.reload(),alert("Uma nova versão será carregada!"))},!1)},!1)}]),app.constant("APP_EVENTS",{offline:"app-events-offline"}),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized",exit:"exit",sistema:"sistema",mensagem:"mensagem",produto:"produto",fase:"fase",quantidade:"qtde"}),app.constant("USER_ROLES",{ANALISE:"ANALISE",PROSPECCAO:"PROSPECCAO",INTERNALIZACAO:"INTERNALIZACAO",SUSTENTACAO:"SUSTENTACAO",DECLINIO:"DECLINIO",ADMINISTRADOR:"ADMINISTRADOR",CADASTRADOR:"CADASTRADOR",CONSULTOR:"CONSULTOR",LEGADO:"LEGADO",NOT_LOGGED:"NOT_LOGGED"}),app.factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS","APP_EVENTS",function(a,b,c,d){return{responseError:function(e){return a.$broadcast({0:d.offline,404:d.offline,503:d.offline,401:c.notAuthenticated,403:c.notAuthorized,419:c.sessionTimeout,440:c.sessionTimeout}[e.status],e),b.reject(e)}}}]),app.value("version","1.0.0"),angular.module("Config",[]).constant("ENV",{name:"production",apiEndpoint:"/pto/"}),app.controller("ApplicationController",["$rootScope","USER_ROLES","AuthService","$notification",function(a,b,c,d){}]),app.controller("ArquivosController",["$scope","$rootScope","$http","Upload","$timeout","$location","$routeParams","AlertService","ArquivosService",function(a,b,c,d,e,f,g,h,i){a.uploadFiles=function(b,c){a.files=b,a.errFiles=c,angular.forEach(b,function(b){b.upload=d.upload({url:"api/v1/arquivos/upload",data:{file:b}}),b.upload.then(function(a){e(function(){b.result=a.data})},function(b){b.status>0&&(a.errorMsg=b.status+": "+b.data)},function(a){b.progress=Math.min(100,parseInt(100*a.loaded/a.total))})})}}]),app.controller("AuthController",["$scope","$rootScope","AUTH_EVENTS","AuthService","$notification",function(a,b,c,d,e){function f(a,b){switch($("[id$='-message']").text(""),b){case 412:case 422:$.each(a,function(a,b){$("#"+b.property+"-message").text(b.message)});break;case 401:$("#message").html("Usuário ou senha inválidos.")}}a.credentials={username:"",password:""},a.login=function(a){d.login(a).then(function(){b.$broadcast(c.loginSuccess)},function(a){b.$broadcast(c.loginFailed),f(a.data,a.status)})},a.logout=function(){b.$broadcast(c.logoutSuccess)}}]),app.controller("DashboardController",["$scope","ftsService",function(a,b){a.texto="",a.resultados=[],a.buscaFTS=function(){b.buscaFTS(a.texto).then(function(b){a.resultados=b})}}]),app.directive("uiLinhabar",["$rootScope","$anchorScroll",function(a,b){return{restrict:"AC",template:'<span class="bar"></span>',link:function(a,c,d){c.addClass("linhabar hide"),a.$on("$routeChangeStart",function(a){b(),c.removeClass("hide").addClass("active")}),a.$on("$routeChangeSuccess",function(a,b,d,e){a.targetScope.$watch("$viewContentLoaded",function(){c.addClass("hide").removeClass("active")})})}}}]),app.directive("backButton",function(){return{restrict:"A",link:function(a,b,c){b.bind("click",function(){history.back(),a.$apply()})}}}),app.directive("alerts",function(){return{restrict:"E",templateUrl:"partials/alerts.html"}}),app.directive("loadingIndicator",function(){return{restrict:"A",templateUrl:"partials/loading.html",link:function(a,b,c){a.$on("loading-started",function(a){b.css({display:""})}),a.$on("loading-complete",function(a){b.css({display:"none"})})}}}),app.directive("autofill",function(){return{require:"ngModel",link:function(a,b,c,d){a.$on("autofill:update",function(){d.$setViewValue(b.val())})}}}),app.directive("appVersion",["version",function(a){return function(b,c,d){c.text(a)}}]),app.directive("hasRoles",["AuthService",function(a){return{restrict:"A",link:function(b,c,d){var e=d.hasRoles.split(",");a.isAuthorized(e)||c.remove()}}}]),app.directive("confirmButton",["$timeout",function(a){return{restrict:"A",scope:{actionOK:"&confirmAction",actionCancel:"&cancelAction"},link:function(b,c,d){var e,f,g,h,i;e=Math.floor(1e10*Math.random()),d.buttonId=e,f=d.message||"Tem certeza?",i=d.yes||"Sim",g=d.no||"Não",h=d.title||"Confirm",c.bind("click",function(c){bootbox.dialog({message:f,title:h,buttons:{success:{label:i,className:"btn-success",callback:function(){a(function(){b.$apply(b.actionOK)})}},danger:{label:g,className:"btn-danger",callback:function(){b.$apply(b.actionCancel)}}}})})}}}]),app.directive("validationMsg",["ValidationService",function(a){return{restrict:"E",scope:{propriedade:"@"},template:"<div class='error text-danger' ng-show='msg'><small class='error' >{{msg}}</small></div>",controller:["$scope",function(b){b.$watch(function(){return a.validation[b.propriedade]},function(a){b.msg=a})}]}}]),app.directive("maxLength",["$compile","AlertService",function(a,b){return{restrict:"A",require:"ngModel",link:function(a,c,d,e){d.$set("ngTrim","false");var f=parseInt(d.maxLength,10);e.$parsers.push(function(a){return void 0!==a&&void 0!==a.length&&a.length>f&&(b.addWithTimeout("warning","O valor máximo de caracteres ("+f+") para esse campo já foi alcançado"),a=a.substr(0,f),e.$setViewValue(a),e.$render()),a})}}}]),app.directive("hasRolesDisable",["AuthService",function(a){return{restrict:"A",link:function(b,c,d){var e=d.hasRolesDisable.split(",");a.isAuthorized(e)||angular.forEach(c.find("input, select, textarea, button, a"),function(a){var b=angular.element(a);b.attr("disabled","true")})}}}]),app.directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),app.directive("queryBuilder",["$compile",function(a){return{restrict:"E",scope:{group:"=",fields:"="},templateUrl:"partials/queryBuilderDirective.html",compile:function(b,c){var d,e;return d=b.contents().remove(),function(b,c,f){b.hideGroup=!0,b.count=1,b.limit=5,b.maxCount=!1,b.operators=[{name:"E"},{name:"OU"}],b.conditions=[{name:"="},{name:"<>"},{name:"<"},{name:"<="},{name:">"},{name:">="}],b.addCondition=function(){b.group.rules.push({condition:"=",field:"=",data:""}),b.count+=1,b.count===b.limit&&(b.maxCount=!0)},b.removeCondition=function(a){b.group.rules.splice(a,1),b.count-=1,b.maxCount=!1},b.addGroup=function(){b.group.rules.push({group:{operator:"E",rules:[]}})},b.removeGroup=function(){"group"in b.$parent&&b.$parent.group.rules.splice(b.$parent.$index,1)},e||(e=a(d)),c.append(e(b,function(a){return a}))}}}}]),app.filter("tamanho",function(){return function(a){var b=1024;if(b>a)return a+" B";var c=["kB","MB","GB","TB","PB","EB","ZB","YB"],d=-1;do a/=b,++d;while(a>=b);return a.toFixed(1)+" "+c[d]}}),app.filter("tipoArquivo",function(){var a={},b="images/filetypes/";return a.image=b+"doc.png",a.doc=b+"doc.png",a.xls=b+"xls.png",a.zip=b+"zip.png",a.pdf=b+"pdf.png",a.unknow=b+"unknow.png",function(b){var c=a.unknow;return b.indexOf("image")>-1?c=a.image:b.indexOf("doc")>-1?c=a.doc:b.indexOf("odt")>-1?c=a.odt:b.indexOf("xls")>-1?c=a.xls:b.indexOf("zip")>-1?c=a.zip:b.indexOf("rar")>-1?c=a.zip:b.indexOf("tar")>-1?c=a.zip:b.indexOf("gz")>-1?c=a.zip:b.indexOf("pdf")>-1&&(c=a.pdf),c}});var operacoes={CRIAR:{icone:"glyphicon glyphicon-plus",badge:"info"},ATUALIZAR:{icone:"glyphicon glyphicon-floppy-disk",badge:"primary"},APROVAR:{icone:"glyphicon glyphicon-thumbs-up",badge:"success"},REPROVAR:{icone:"glyphicon glyphicon-thumbs-down",badge:"danger"},FINALIZAR:{icone:"glyphicon glyphicon-ok",badge:"warning"},EXCLUIR:{icone:"glyphicon glyphicon-alert",badge:"danger"}};app.filter("operacaoIcone",function(){return function(a){return operacoes[a].icone}}),app.filter("operacaoClass",function(){return function(a){return operacoes[a].badge}}),app.filter("startFrom",function(){return function(a,b){return a?(b=+b,a.slice(b)):a}}),app.filter("range",function(){return function(a,b){b=parseInt(b);for(var c=0;b>c;c++)a.push(c);return a}}),app.filter("version",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]),app.filter("trunk",function(){return function(a,b,c,d){if(!a)return"";if(c=parseInt(c,10),!c)return a;if(a.length<=c)return a;if(a=a.substr(0,c),b){var e=a.lastIndexOf(" ");-1!=e&&(a=a.substr(0,e))}return a+(d||" …")}}),app.filter("buscaPor",function(){return function(a,b){if(!b)return a;var c=[];return b=b.toLowerCase(),angular.forEach(a,function(a){-1!==a.name.toLowerCase().indexOf(b)&&c.push(a)}),c}}),app.factory("AlertService",["$rootScope","$timeout","$notification",function(a,b,c){var d={};return a.alerts=[],d.addWithTimeout=function(a,c,e){var f=d.add(a,c);b(function(){d.closeAlert(f)},e?e:4e3)},d.add=function(b,c,d){a.alerts.push({type:b,msg:c})},d.closeAlert=function(b){return this.closeAlertIdx(a.alerts.indexOf(b))},d.closeAlertIdx=function(b){return a.alerts.splice(b,1)},d.notification=function(a,b){c(a,{body:b,dir:"auto",delay:1e4,focusWindowOnClick:!0})},d}]),app.factory("AppService",["$window","$rootScope",function(a,b){function c(a){var b=a.replace("-","+").replace("_","/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw"Illegal base64url string!"}return window.atob(b)}var d="CitrinoToken",e={};return e.getToken=function(){var c=a.localStorage.getItem(d);return c&&void 0!==c&&null!==c&&"null"!==c?(b.currentUser||(b.currentUser=e.getUserFromToken()),c):null},e.setToken=function(b){a.localStorage.setItem(d,b)},e.removeToken=function(){a.localStorage.removeItem(d)},e.getUserFromToken=function(){var b=a.localStorage.getItem(d),e=null;if(null!==b&&void 0!==typeof b){var f=b.split(".")[1],g=JSON.parse(c(f));e=JSON.parse(g.user)}return e},e}]),app.service("Session",function(){return this.create=function(a,b){this.userId=a,this.userRole=b},this.destroy=function(){this.userId=null,this.userRole=null},this}),app.factory("ArquivosService",["$http",function(a){var b={};return b.excluir=function(b){return a["delete"]("api/arquivos/"+b).then(function(a){})},b.carregarAnexos=function(b){return a.get("api/arquivos/"+b).then(function(a){return a.data})},b}]),app.factory("AuthService",["$http","AppService","$rootScope",function(a,b,c){var d={};return d.login=function(d){return a.post("api/auth",d).success(function(a,d,e){return b.removeToken(),b.setToken(e("Set-Token")),c.currentUser=b.getUserFromToken(),a})},d.isAuthenticated=function(){return c.currentUser?!0:!1},d.isAuthorized=function(a){if(!d.isAuthenticated())return!1;angular.isArray(a)||(a=[a]);var b=!1,e=c.currentUser.grupos;if(void 0!==e&&null!==e)for(var f=0;f<a.length;f++)for(var g=0;g<e.length;g++)for(var h=0;h<e[g].perfis.length;h++)if(-1!==a[f].indexOf(e[g].perfis[h])){b=!0;break}return b},d}]),app.factory("DashboardService",["$http",function(a){var b={};return b.get=function(){return a.get("api/v1").then(function(a){return a.data})},b}]),app.factory("ftsService",["$http","$q",function(a,b){var c={};return c.buscaFTS=function(c){var d=b.defer();return c=c.replace("/","|"),a({url:"api/v1/arquivos/fts/"+c,method:"GET"}).success(function(a){d.resolve(a)}).error(function(a,b){d.reject([a,b])}),d.promise},c}]),app.factory("WS",["$rootScope","$websocket",function(a,b){var c={};return c}]);